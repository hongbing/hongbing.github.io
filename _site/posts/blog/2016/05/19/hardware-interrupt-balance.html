<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>硬件中断均衡 </title>
    <meta name="author" content="hongbing" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="hongbing的部落格" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
    <link rel="shortcut icon" href="/jinchuan.png" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>
      <div id="header_wrap" class="outer">
        <header class="inner">
                <div id="project_title" align="center"><a href="/">hongbingの部落格</a></div>
                <div id="project_tagline" align="center">ONCE A GEEK, FOREVER A GEEK</div>
    <!--    
	        <div id="nav" class="navbar">
                         <div id="home" class="navbar"><a href="/">Home</a></div>
                         <div id="archive" class="navbar"><a href="/archive">Archive</a></div>
                         <div id="about" class="navbar"><a href="/about">About</a></div>
                </div>
-->	</header>
</div>
 
         <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/posts/blog/2016/05/19/hardware-interrupt-balance.html" title="硬件中断均衡">硬件中断均衡</a></h1>
        <p class="entry-date">2016-05-19</p>
<!--
	
-->
	<p>硬件与cpu沟通有两种方式，一种是中断，另一种是轮询。中断是硬件主动，产生中断信号，中断控制器将信号传递给cpu，cpu停下手中的工作，执行中断任务；轮询则为cpu主动，定时查询硬件设备的状态，是否处理硬件请求。
<!-- more --></p>

<p>硬件中断又分为两类：</p>

<ul>
  <li><strong>Non-maskable interrupts [NMI]（不可屏蔽中断）</strong></li>
</ul>

<p>不可屏蔽中断针对的是严重的硬件错误，比如内存错误，传感器错误等等。出现这种中断一般需要硬件工程师介入，检测错误类型。</p>

<ul>
  <li><strong>Maskable interrupts（可屏蔽中断）</strong></li>
</ul>

<p>对于IO密集型的服务来说，网卡中断会非常的频繁，每一次硬件中断都需要CPU作出响应，大量的中断其实是一件比较消耗CPU的操作。
如果中断又都集中在某一个cpu上，那么对服务的影响就比较大，这时就需要将中断分散到各个cpu上均衡处理，由此就有了下面要介绍的网卡多队列,以及相关的优化技术。</p>

<h4 id="rssreceive-side-scaling">1. RSS（Receive Side Scaling）</h4>
<p>RSS需要硬件支持，通过<code class="highlighter-rouge">lspci -vvv | grep -i msi-x</code>命令来查看Ethernet controller中是否有MSI-X，Enable+，TabSize &gt; 1来判断是否硬件支持。</p>

<p>RSS的原理，简单描述就是<strong>通过过滤规则将网络包分发到不同的队列，每个队列通过关联的中断由指定的不同CPU处理。</strong>
使用RSS，既能缩短单个队列长度（降低延迟），又能均衡cpu的处理能力（不至于某个cpu达到瓶颈）。
下面一一解释上面的关键字：过滤规则，队列，中断，CPU</p>

<ul>
  <li><strong>过滤规则</strong></li>
</ul>

<p>过滤规则就是hash函数，对IP packet或TCP segment的header进行hash，分发到不同的队列。</p>

<ul>
  <li><strong>队列关联中断号</strong></li>
</ul>

<p>通过<code class="highlighter-rouge">cat /proc/interrupts</code>查看网卡队列对应的中断号。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>//查看各cpu中断类型
[root@XX-0-79-core ~]# cat /proc/interrupts
            CPU0       CPU1       CPU2       CPU3
   0:         57          0          0          0   IO-APIC-edge      timer
   1:         10          0          0          0   IO-APIC-edge      i8042
   6:          3          0          0          0   IO-APIC-edge      floppy
   8:          0          0          0          0   IO-APIC-edge      rtc0
   9:          0          0          0          0   IO-APIC-fasteoi   acpi
  12:        144          0          0          0   IO-APIC-edge      i8042
  61:         2346          0          0          0   PCI-MSI-edge      eth0-0
  62:          0         208711        0         0   PCI-MSI-edge      eth0-1
  63:         0          0                 0     147535          PCI-MSI-edge      eth0-2
</code></pre>
</div>

<p>第1栏表示中断号，第2-5栏表示在CPU0-3上处理的中断数量，第6栏表示中断控制器，APIC表示高级可编程中断控制器。不支持APIC的控制器，不能完成中断绑定，默认发往cpu0：</p>

<blockquote>
  <p>Without an IO-APIC, interrupts from hardware will be delivered only to the CPU which boots the operating system (usually CPU#0)</p>
</blockquote>

<p>最后一栏表示中断类型，timer时钟中断，eth0-0，eth0-1即是0号网卡的0号队列和1号队列，从表中可以看出，eth0-0，eth0-1，eth0-2分别对应中断号61，62，63。</p>

<ul>
  <li><strong>中断号与CPU亲和</strong></li>
</ul>

<p>将网卡中断号通过CPU亲和度绑定到某个CPU上即可，具体绑定方式可以查看linux文档Documentation/IRQ-affinity.txt。每个队列都关联一个中断号，当一个包到达队列之后，网卡就触发该队列关联的中断请求，通过刚刚绑定的CPU处理中断。</p>

<p>中断号的大小即决定了CPU处理中断请求的优先级，中断号越小，优先级越高。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>IRQ 0 — **system timer (cannot be changed)**
IRQ 1 — **keyboard controller (cannot be changed)**
IRQ 3 — serial port controller for serial port 2 (shared with serial port 4, if present);
IRQ 4 — serial port controller for serial port 1 (shared with serial port 3, if present);
IRQ 5 — parallel port 2 and 3 or sound card;
IRQ 6 — floppy disk controller;
IRQ 7 — parallel port 1. It is used for printers or for any parallel port if a printer is not present.
</code></pre>
</div>

<p>如果手动设置了CPU亲和度绑定，需要将irqbalance后台进程关掉（<code class="highlighter-rouge">service irqbalance status；service irqbalance stop</code>），因为它会自动将不同的中断交给各个cpu处理，会覆盖掉手动设置值。</p>

<p>对于延迟特别敏感，或者接收中断处理已经成为瓶颈的系统应该开启RSS。但是应该控制队列在cpu物理核上的数量。</p>

<blockquote>
  <p>Per-cpu load can be observed using the mpstat utility, but note that on processors with hyperthreading (HT), each hyperthread is represented as a separate CPU. For interrupt handling, HT has shown no benefit in initial tests, so limit the number of queues to the number of CPU cores in the system.</p>
</blockquote>

<h4 id="rpsreceive-packet-steering">2. RPS（Receive Packet Steering）</h4>

<p>RPS可以看做是RSS的软件实现。原理简单描述为对<code class="highlighter-rouge">数据流hash分类</code>，并将软中断负载均衡到各CPU。不会增加网卡的硬中断速率，但是引入了处理器间的中断。</p>

<p><strong>优化方式：</strong></p>

<p>调整<code class="highlighter-rouge">/sys/class/net/[device]/queues/rx-[num]/rps_cpus</code>的值,rps_cpus默认为0000，每一位表示16进制位。000f表示使用cpu0，cpu1，cpu2，cpu3。</p>

<h4 id="rfsreceive-flow-steering">3. RFS（Receive Flow Steering）</h4>

<p>解决处理网卡数据流的cpu与接受该数据流的应用程序所运行的cpu不一致，造成cpu切换的问题。保证程序运行的CPU和软中断处理CPU是同一个，<code class="highlighter-rouge">提升CPU缓存命中率，降低网络延迟</code>。</p>

<p><strong>优化方式：</strong></p>

<p>要开启RFS，需要修改两个参数，</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/proc/sys/net/core/rps_sock_flow_entries
/sys/class/net/[device]/queues/rx-[num]/rps_flow_cnt
</code></pre>
</div>
<p>设置rps_sock_flow_entries的值为期望获得的最大并发连接的数量（该值必须为2的幂，如果不是，系统设置为向上最接近的2的幂），rps_flow_cnt的值为rps_sock_flow_entries/N，N表示设备接收队列的数量，对于单队列两者设置为同一值。</p>

<h4 id="xpstransmit-packet-steering">4. XPS（Transmit Packet Steering）</h4>

<p>针对网卡发送时的优化，RFS是根据包接收的队列来选择cpu，而XPS是根据cpu来选择要发送的网卡队列。</p>

<p><strong>优化方式：</strong></p>

<p>修改<code class="highlighter-rouge">/sys/class/net/[device]/queues/tx-[num]/xps_cpus</code></p>

<p>注意RPS和RFS在linux 内核版本2.6.35才被引入，2.6.38及其以上才包含XPS。</p>

<p><img src="/images/hardwareinterrupt/hardware-interrupt.png" alt="hardware-interrupt" /></p>

<h5 id="section">参考</h5>

<p>[1] <a href="http://blog.netzhou.net/?p=181">http://blog.netzhou.net/?p=181</a></p>

<p>[2] <a href="http://hellojava.info/?p=238">http://hellojava.info/?p=238</a></p>

<p>[3] <a href="http://blog.csdn.net/wyaibyn/article/details/14109325">http://blog.csdn.net/wyaibyn/article/details/14109325</a></p>

<p>[4] <a href="https://lwn.net/Articles/412062/">https://lwn.net/Articles/412062/</a></p>


	<ul class="pager">
            
            <li class="previous"><a href="/posts/blog/2016/04/17/a-oom-problem.html" title="一次oom的排查过程">上一篇 一次oom的排查过程</a></li>
	    

            
            <li class="next"><a href="/posts/blog/2016/05/21/linux-common-command.html" title="工作中常用的linux命令">下一篇 工作中常用的linux命令</a></li>
            
	</ul>
	<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hongbing.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    </div>

    <div class="sidenav">
	<iframe width="100%" height="85" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=85&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2702608131&verifier=f3af5509&dpc=1"></iframe>
    </div>

    <div class="sidenav">
        <h2>Blog</h2>
        <ul class="artical-list">
        
<<<<<<< HEAD
            <li><a href="/posts/blog/2017/02/12/spring-session.html">spring session源码解析</a></li>
        
            <li><a href="/posts/blog/2016/06/15/nginx-lua.html">openresty memcached实践</a></li>
        
=======
>>>>>>> parent of 6c51ec1... add nginx_lua
            <li><a href="/posts/blog/2016/05/21/linux-common-command.html">工作中常用的linux命令</a></li>
        
            <li><a href="/posts/blog/2016/05/19/hardware-interrupt-balance.html">硬件中断均衡</a></li>
        
            <li><a href="/posts/blog/2016/04/17/a-oom-problem.html">一次oom的排查过程</a></li>
        
            <li><a href="/posts/blog/2015/11/14/monitor-principle.html">监控模式</a></li>
        
            <li><a href="/posts/blog/2015/11/14/jetty-deadlock.html">jetty6 deadlock</a></li>
        
            <li><a href="/posts/blog/2015/08/21/linux-of-blockdump.html">linux系统之block_dump</a></li>
        
            <li><a href="/posts/blog/2015/08/20/linux-of-pdflush.html">linux系统之pdflush</a></li>
        
            <li><a href="/posts/blog/2015/08/11/UnknowHostException.html">UnknowHostException</a></li>
        
            <li><a href="/posts/blog/2015/08/02/haproxy-install.html">haproxy部署</a></li>
        
            <li><a href="/posts/blog/2015/07/25/maven-introduce.html">maven实践</a></li>
        
            <li><a href="/posts/blog/2015/06/21/etcd-vs-consul.html">ETCD vs. Consul</a></li>
        
            <li><a href="/posts/blog/2015/06/21/distributed-id-generator.html">分布式ID生成器</a></li>
        
            <li><a href="/posts/blog/2015/06/17/what-is-good-code.html">什么样的代码才是好的代码</a></li>
        
            <li><a href="/posts/blog/2015/06/17/raft-introduce.html">Raft</a></li>
        
        </ul>
<!--
        <h2>Opinion</h2>
        <ul class="artical-list">
        
        </ul>

        <h2>Project</h2>
        <ul class="artical-list">
        
        </ul>-->
     </div>
</div>
<script src="/js/jquery-1.7.1.min.js"" type="text/javascript"></script>
<script src="/js/post.js" type="text/javascript"></script>

      

</body>
</html>

---
layout: post
title: 为什么web服务器返回502
description:  
categories: posts blog
---

  前段时间收到业务方反馈说他们请求任务调度系统经常会收到“502 Bad Gateway”的错误信息，导致不少任务创建失败。
![why502](/images/why502/0829_1.png)

在弄清楚为什么任务调度系统会返回“502 Bad Gateway”之前，我们首先应该搞清楚什么是502。

RFC是这样说的：<!-- more -->
> The 502 (Bad Gateway) status code indicates that the server, while acting as a gateway or proxy, received an invalid response from an inbound server it accessed while attempting to fulfill the request.
翻译一下：
  502状态码表示作为网关或者代理的server在请求时收到了上游server的无效响应。
白话就是说，A（比如nginx）请求B（tomcat，或者php-fpm），B没有应A的请求返回正确的数据，A收到了无效的返回。

从定义上来看，我们知道是B返回了无效的数据。
另外需要说明的是，上面图中显示502错误信息的并不是nginx服务器，而是调用方的业务服务器。整个链路是下面这样：
> 调用方server --> lvs --> nginx --> 任务调度server

从整个调用链路上来看，lvs，nginx，或者任务调度server任何一个都有可能是导致调用方server收到了502请求的罪魁祸首。

那么应该怎么来排查是谁返回了502呢？

`看日志。`

查看lvs和nginx的日志，看是否有收到502的返回。实际上，在nginx的access日志上看到了任务调度server返回的502.

现在要确定任务调度server为什么返回502？

看日志，任务调度server上没有任何有关502的记录，接下来该怎么办？

`抓包。`

在nginx和调度server一起抓包，实际情况是在server上看到了下面的现象：
![why502](/images/why502/0829_2.png)

82是nginx，106是调度server。可以看到319756-319758nginx主动建立连接，319759-319769nginx一次post请求，server返回HTTP/1.1 200，并且server收到了nginx的ack确认。
219769与320738之间间隔了7s多，也即是此刻连接空闲了7s多，之后由server主动发起fin包，同一时刻，nginx也向server发了一个post请求（320751包）。因为server已经要主动关闭连接了，所以不会处理nginx发出的post请求，server发了一个rst包，希望重置连接。nginx收到后，也同意断开连接，也回复了FIN,ACK包。此时，在nginx一端的acess日志我们看到了502请求。

那这里我们搞清楚了502无效响应是怎么出现的。

即：调度server主动关闭连接，但同时nginx仍有请求发到server，server无法处理，发RST包给nginx，nginx无奈也同意关闭连接，这一次请求就失败了，表现出来就是nginx收到502，最终经过lvs返回给调用方。

那么为什么server要主动关闭连接？

因为空闲，空闲了7s。nginx有设置keepalive_timeout,时间是60s。

从这个信息，猜测是因为server tomcat的keepalive时间是7s，所以server等待连接空闲7s后，主动关闭了连接。

tomcat8的keepalive时间是通过里下面两个参数确定的。
![why502](/images/why502/0829_3.png)

而我们代码里确实设置了connectionTimeout，值是7000.
![why502](/images/why502/0829_4.png)


到这里，问题的原因找到了。为了避免server主动关闭连接导致502的这个问题，需要把tomcat的keepalive时间设置得比nginx的长一些，这样即便是空闲连接到达关闭的时间，也是由nginx主动关闭，而不是由上游服务器来关闭。由于nginx设置的60s，tomcat这里设置90s就可以了。改完配置后502立马消失了。
![why502](/images/why502/0829_5.png)


#### 参考资料
[1] [rfc](https://tools.ietf.org/html/rfc7231#section-6.6.3)

[2] [Optimizing the network for HTTP by setting the HTTP keep-alive option](https://docs.bmc.com/docs/ars81/fine-tuning-the-network-for-http-protocol-258511131.html)

[3] [Wireshark](https://www.wireshark.org/)

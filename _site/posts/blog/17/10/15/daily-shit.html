<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>20171015一周坑 </title>
    <meta name="author" content="hongbing" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="hongbing的部落格" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
    <link rel="shortcut icon" href="/jinchuan.png" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>
      <div id="header_wrap" class="outer">
        <header class="inner">
                <div id="project_title" align="center"><a href="/">hongbingの部落格</a></div>
                <div id="project_tagline" align="center">ONCE A GEEK, FOREVER A GEEK</div>
    <!--    
	        <div id="nav" class="navbar">
                         <div id="home" class="navbar"><a href="/">Home</a></div>
                         <div id="archive" class="navbar"><a href="/archive">Archive</a></div>
                         <div id="about" class="navbar"><a href="/about">About</a></div>
                </div>
-->	</header>
</div>
 
         <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/posts/blog/17/10/15/daily-shit.html" title="20171015一周坑">20171015一周坑</a></h1>
        <p class="entry-date">2017-10-15</p>
<!--
	
-->
	<h5 id="1-disconf加载类的坑">1. disconf加载类的坑</h5>
<p>在做push工程的时候，使用disconf动态配置极光的masterSecret和key，但是一直不成功，配置无法更新，始终使用的是默认的配置值。disconf下载的本地文件里面，各项配置都是动态更新的，而且在其他工程里面同样的使用方式都没有问题，判断是因为配置类没有被disconf加载到导致的。
为什么没有被加载到？ <!-- more --></p>

<p>disconf相关配置如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> &lt;bean id="disconfMgrBean" class="com.baidu.disconf.client.DisconfMgrBean"
          destroy-method="destroy"&gt;
        &lt;property name="scanPackage" value="com.uxin.zb,  com.uxin.commons"/&gt;
    &lt;/bean&gt;
    &lt;bean id="disconfMgrBean2" class="com.baidu.disconf.client.DisconfMgrBeanSecond"
          init-method="init" destroy-method="destroy"&gt;
    &lt;/bean&gt;
</code></pre></div></div>

<p>打开disconf的debug日志，可以看到在disconf静态扫描时候的日志</p>
<blockquote>
  <p>start to scan package: com.uxin.zb,  com.uxin.commons</p>
</blockquote>

<p>说明disconf已经开始要去加载这两个包，但是为什么包里面的配置相关的类没有加载进来呢？看代码也没发现什么问题，只得下载disconf的源码，在源码里面加了些DEBUG日志，然后打包在测试环境使用，最终发现问题所在。</p>

<p>在初始化DisconfMgrBean的时候，会根据scanPackage参数来解析需要扫描的包名，解析方法是下面的<code class="highlighter-rouge">StringUtil.parseStringToStringList()</code>， 参数token为逗号，source即为’com.uxin.zb,  com.uxin.commons’，因为在逗号之间多加了个空格，所以解析出来的包包括com.uxin.zb和空格com.uxin.commons, 因此在根据包名查找classpath下面相应的文件时就没有找到对应com.uxin.commons包的zb-commons.jar包，导致了配置类没有加载进来，无法使用disconf的动态配置。</p>

<p>一个空格导致的问题，也是disconf的一个bug。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static List&lt;String&gt; parseStringToStringList(String source,
                                                       String token) {

        if (StringUtils.isBlank(source) || StringUtils.isEmpty(token)) {
            return null;
        }

        List&lt;String&gt; result = new ArrayList&lt;String&gt;();

        String[] units = source.split(token);
        for (String unit : units) {
            result.add(unit);
        }
        return result;
    }

</code></pre></div></div>

<h5 id="2-drds使用mysql别名的坑">2. DRDS使用mysql别名的坑</h5>
<p>项目中使用mybatis操作数据库，自定义了查询主播粉丝uid的最大值和最小值的mapper，最大值和最小值都使用了别名，返回结果map。在返回结果里读取粉丝uid的最大值和最小值<code class="highlighter-rouge">map.get("maxUid"), map.get("minUid")</code>。在测试环境里面测试通过了，上线之后就发现了NPE异常。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;select id="selectMaxMinByToUid" parameterType="java.lang.Long" resultType="java.util.Map"&gt;
    select max(from_uid) as "maxUid",
    min(from_uid) as "minUid"
    from user_follow
    where to_uid = #{toUid,jdbcType=BIGINT}
  &lt;/select&gt;
</code></pre></div></div>

<p>分析测试环境与线上的差异，测试环境使用的是本机mysql数据库，线上用户关系库使用的是阿里云的drds。在线上执行mybatis解析后的sql语句</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> mysql&gt; select max(from_uid) as "maxUid", min(from_uid) as "minUid" from user_follow where to_uid=18xxxxxx;
+---------------+---------------+
| 'maxUid'      | 'minUid'      |
+---------------+---------------+
| 20xxxxxxxxxx1 | 17xxxxxxxxxx3 |
+---------------+---------------+
</code></pre></div></div>

<p>发现返回的map结果中的key并不是maxUid和minUid，而是’maxUid’和’minUid’，所以后续再读取这两个key的时候会抛出NPE异常。再测试一下将别名的双引号去掉，返回的key就没有单引号。同样的语句，不管是别名有没有双引号在mysql中执行时，返回的key都是不带单引号的。因此，断定是阿里云的drds给带有双引号的别名的返回结果加上了单引号。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; select max(from_uid) as maxUid, min(from_uid) as minUid from user_follow where to_uid=188xxxxx;
+---------------+---------------+
| maxUid        | minUid        |
+---------------+---------------+
| 191xxxx111111 | 17xxxxxxx9623 |
+---------------+---------------+
</code></pre></div></div>
<p>解决方法就是将别名的双引号去掉就ok了。</p>


	<ul class="pager">
            
            <li class="previous"><a href="/posts/blog/17/04/22/spring-session-with-sharded-session.html" title="spring-session支持分片redis">上一篇 spring-session支持分片redis</a></li>
	    

            
            <li class="next"><a href="/posts/blog/17/10/15/dynamic-change-logger-level.html" title="动态变更log4j日志级别">下一篇 动态变更log4j日志级别</a></li>
            
	</ul>
	<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hongbing.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    </div>

    <div class="sidenav">
	<iframe width="100%" height="85" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=85&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2702608131&verifier=f3af5509&dpc=1"></iframe>
    </div>

    <div class="sidenav">
        <h2>Blog</h2>
        <ul class="artical-list">
        
            <li><a href="/posts/blog/19/08/29/why-502.html">为什么web服务器返回502</a></li>
        
            <li><a href="/posts/blog/18/04/22/redis-data-migration.html">阿里云redis数据拆分</a></li>
        
            <li><a href="/posts/blog/18/01/01/schedule-thread-executor-not-work.html">定时任务怎么不定时执行了</a></li>
        
            <li><a href="/posts/blog/17/10/15/dynamic-change-logger-level.html">动态变更log4j日志级别</a></li>
        
            <li><a href="/posts/blog/17/10/15/daily-shit.html">20171015一周坑</a></li>
        
            <li><a href="/posts/blog/17/04/22/spring-session-with-sharded-session.html">spring-session支持分片redis</a></li>
        
            <li><a href="/posts/blog/17/02/12/spring-session.html">spring session源码解析</a></li>
        
            <li><a href="/posts/blog/16/05/21/linux-common-command.html">工作中常用的linux命令</a></li>
        
            <li><a href="/posts/blog/16/05/19/hardware-interrupt-balance.html">硬件中断均衡</a></li>
        
            <li><a href="/posts/blog/16/04/17/a-oom-problem.html">一次oom的排查过程</a></li>
        
            <li><a href="/posts/blog/15/11/14/monitor-principle.html">监控模式</a></li>
        
            <li><a href="/posts/blog/15/11/14/jetty-deadlock.html">jetty6 deadlock</a></li>
        
            <li><a href="/posts/blog/15/08/21/linux-of-blockdump.html">linux系统之block_dump</a></li>
        
            <li><a href="/posts/blog/15/08/20/linux-of-pdflush.html">linux系统之pdflush</a></li>
        
            <li><a href="/posts/blog/15/08/11/UnknowHostException.html">UnknowHostException</a></li>
        
            <li><a href="/posts/blog/15/08/02/haproxy-install.html">haproxy部署</a></li>
        
            <li><a href="/posts/blog/15/07/25/maven-introduce.html">maven介绍</a></li>
        
            <li><a href="/posts/blog/15/06/21/etcd-vs-consul.html">ETCD vs. Consul</a></li>
        
            <li><a href="/posts/blog/15/06/21/distributed-id-generator.html">分布式ID生成器</a></li>
        
            <li><a href="/posts/blog/15/06/17/what-is-good-code.html">什么样的代码才是好的代码</a></li>
        
            <li><a href="/posts/blog/15/06/17/raft-introduce.html">Raft</a></li>
        
        </ul>
<!--
        <h2>Opinion</h2>
        <ul class="artical-list">
        
        </ul>

        <h2>Project</h2>
        <ul class="artical-list">
        
        </ul>-->
     </div>
</div>
<script src="/js/jquery-1.7.1.min.js"" type="text/javascript"></script>
<script src="/js/post.js" type="text/javascript"></script>

      

</body>
</html>

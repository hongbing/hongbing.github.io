<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>为什么web服务器返回502 </title>
    <meta name="author" content="hongbing" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="hongbing的部落格" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
    <link rel="shortcut icon" href="/jinchuan.png" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>
      <div id="header_wrap" class="outer">
        <header class="inner">
                <div id="project_title" align="center"><a href="/">hongbingの部落格</a></div>
                <div id="project_tagline" align="center">ONCE A GEEK, FOREVER A GEEK</div>
    <!--    
	        <div id="nav" class="navbar">
                         <div id="home" class="navbar"><a href="/">Home</a></div>
                         <div id="archive" class="navbar"><a href="/archive">Archive</a></div>
                         <div id="about" class="navbar"><a href="/about">About</a></div>
                </div>
-->	</header>
</div>
 
         <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/posts/blog/19/08/29/why-502.html" title="为什么web服务器返回502">为什么web服务器返回502</a></h1>
        <p class="entry-date">2019-08-29</p>
<!--
	
-->
	<p>前段时间收到业务方反馈说他们请求任务调度系统经常会收到“502 Bad Gateway”的错误信息，导致不少任务创建失败。
<img src="/images/why502/0829_1.png" alt="why502" /></p>

<p>在弄清楚为什么任务调度系统会返回“502 Bad Gateway”之前，我们首先应该搞清楚什么是502。</p>

<p>RFC是这样说的：<!-- more --></p>
<blockquote>
  <p>The 502 (Bad Gateway) status code indicates that the server, while acting as a gateway or proxy, received an invalid response from an inbound server it accessed while attempting to fulfill the request.
翻译一下：
  502状态码表示作为网关或者代理的server在请求时收到了上游server的无效响应。
白话就是说，A（比如nginx）请求B（tomcat，或者php-fpm），B没有应A的请求返回正确的数据，A收到了无效的返回。</p>
</blockquote>

<p>从定义上来看，我们知道是B返回了无效的数据。
另外需要说明的是，上面图中显示502错误信息的并不是nginx服务器，而是调用方的业务服务器。整个链路是下面这样：</p>
<blockquote>
  <p>调用方server –&gt; lvs –&gt; nginx –&gt; 任务调度server</p>
</blockquote>

<p>从整个调用链路上来看，lvs，nginx，或者任务调度server任何一个都有可能是导致调用方server收到了502请求的罪魁祸首。</p>

<p>那么应该怎么来排查是谁返回了502呢？</p>

<p><code class="highlighter-rouge">看日志。</code></p>

<p>查看lvs和nginx的日志，看是否有收到502的返回。实际上，在nginx的access日志上看到了任务调度server返回的502.</p>

<p>现在要确定任务调度server为什么返回502？</p>

<p>看日志，任务调度server上没有任何有关502的记录，接下来该怎么办？</p>

<p><code class="highlighter-rouge">抓包。</code></p>

<p>在nginx和调度server一起抓包，实际情况是在server上看到了下面的现象：
<img src="/images/why502/0829_2.png" alt="why502" /></p>

<p>82是nginx，106是调度server。可以看到319756-319758nginx主动建立连接，319759-319769nginx一次post请求，server返回HTTP/1.1 200，并且server收到了nginx的ack确认。
219769与320738之间间隔了7s多，也即是此刻连接空闲了7s多，之后由server主动发起fin包，同一时刻，nginx也向server发了一个post请求（320751包）。因为server已经要主动关闭连接了，所以不会处理nginx发出的post请求，server发了一个rst包，希望重置连接。nginx收到后，也同意断开连接，也回复了FIN,ACK包。此时，在nginx一端的acess日志我们看到了502请求。</p>

<p>那这里我们搞清楚了502无效响应是怎么出现的。</p>

<p>即：调度server主动关闭连接，但同时nginx仍有请求发到server，server无法处理，发RST包给nginx，nginx无奈也同意关闭连接，这一次请求就失败了，表现出来就是nginx收到502，最终经过lvs返回给调用方。</p>

<p>那么为什么server要主动关闭连接？</p>

<p>因为空闲，空闲了7s。nginx有设置keepalive_timeout,时间是60s。</p>

<p>从这个信息，猜测是因为server tomcat的keepalive时间是7s，所以server等待连接空闲7s后，主动关闭了连接。</p>

<p>tomcat8的keepalive时间是通过里下面两个参数确定的。
<img src="/images/why502/0829_3.png" alt="why502" /></p>

<p>而我们代码里确实设置了connectionTimeout，值是7000.
<img src="/images/why502/0829_4.png" alt="why502" /></p>

<p>到这里，问题的原因找到了。为了避免server主动关闭连接导致502的这个问题，需要把tomcat的keepalive时间设置得比nginx的长一些，这样即便是空闲连接到达关闭的时间，也是由nginx主动关闭，而不是由上游服务器来关闭。由于nginx设置的60s，tomcat这里设置90s就可以了。改完配置后502立马消失了。
<img src="/images/why502/0829_5.png" alt="why502" /></p>

<h4 id="参考资料">参考资料</h4>
<p>[1] <a href="https://tools.ietf.org/html/rfc7231#section-6.6.3">rfc</a></p>

<p>[2] <a href="https://docs.bmc.com/docs/ars81/fine-tuning-the-network-for-http-protocol-258511131.html">Optimizing the network for HTTP by setting the HTTP keep-alive option</a></p>

<p>[3] <a href="https://www.wireshark.org/">Wireshark</a></p>

	<ul class="pager">
            
            <li class="previous"><a href="/posts/blog/18/04/22/redis-data-migration.html" title="阿里云redis数据拆分">上一篇 阿里云redis数据拆分</a></li>
	    

            
	</ul>
	<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hongbing.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    </div>

    <div class="sidenav">
	<iframe width="100%" height="85" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=85&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2702608131&verifier=f3af5509&dpc=1"></iframe>
    </div>

    <div class="sidenav">
        <h2>Blog</h2>
        <ul class="artical-list">
        
            <li><a href="/posts/blog/19/08/29/why-502.html">为什么web服务器返回502</a></li>
        
            <li><a href="/posts/blog/18/04/22/redis-data-migration.html">阿里云redis数据拆分</a></li>
        
            <li><a href="/posts/blog/18/01/01/schedule-thread-executor-not-work.html">定时任务怎么不定时执行了</a></li>
        
            <li><a href="/posts/blog/17/10/15/dynamic-change-logger-level.html">动态变更log4j日志级别</a></li>
        
            <li><a href="/posts/blog/17/10/15/daily-shit.html">20171015一周坑</a></li>
        
            <li><a href="/posts/blog/17/04/22/spring-session-with-sharded-session.html">spring-session支持分片redis</a></li>
        
            <li><a href="/posts/blog/17/02/12/spring-session.html">spring session源码解析</a></li>
        
            <li><a href="/posts/blog/16/05/21/linux-common-command.html">工作中常用的linux命令</a></li>
        
            <li><a href="/posts/blog/16/05/19/hardware-interrupt-balance.html">硬件中断均衡</a></li>
        
            <li><a href="/posts/blog/16/04/17/a-oom-problem.html">一次oom的排查过程</a></li>
        
            <li><a href="/posts/blog/15/11/14/monitor-principle.html">监控模式</a></li>
        
            <li><a href="/posts/blog/15/11/14/jetty-deadlock.html">jetty6 deadlock</a></li>
        
            <li><a href="/posts/blog/15/08/21/linux-of-blockdump.html">linux系统之block_dump</a></li>
        
            <li><a href="/posts/blog/15/08/20/linux-of-pdflush.html">linux系统之pdflush</a></li>
        
            <li><a href="/posts/blog/15/08/11/UnknowHostException.html">UnknowHostException</a></li>
        
            <li><a href="/posts/blog/15/08/02/haproxy-install.html">haproxy部署</a></li>
        
            <li><a href="/posts/blog/15/07/25/maven-introduce.html">maven介绍</a></li>
        
            <li><a href="/posts/blog/15/06/21/etcd-vs-consul.html">ETCD vs. Consul</a></li>
        
            <li><a href="/posts/blog/15/06/21/distributed-id-generator.html">分布式ID生成器</a></li>
        
            <li><a href="/posts/blog/15/06/17/what-is-good-code.html">什么样的代码才是好的代码</a></li>
        
            <li><a href="/posts/blog/15/06/17/raft-introduce.html">Raft</a></li>
        
        </ul>
<!--
        <h2>Opinion</h2>
        <ul class="artical-list">
        
        </ul>

        <h2>Project</h2>
        <ul class="artical-list">
        
        </ul>-->
     </div>
</div>
<script src="/js/jquery-1.7.1.min.js"" type="text/javascript"></script>
<script src="/js/post.js" type="text/javascript"></script>

      

</body>
</html>

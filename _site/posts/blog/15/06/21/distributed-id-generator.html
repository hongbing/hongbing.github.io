<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>分布式ID生成器 </title>
    <meta name="author" content="hongbing" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="hongbing的部落格" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
    <link rel="shortcut icon" href="/jinchuan.png" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>
      <div id="header_wrap" class="outer">
        <header class="inner">
                <div id="project_title" align="center"><a href="/">hongbingの部落格</a></div>
                <div id="project_tagline" align="center">ONCE A GEEK, FOREVER A GEEK</div>
    <!--    
	        <div id="nav" class="navbar">
                         <div id="home" class="navbar"><a href="/">Home</a></div>
                         <div id="archive" class="navbar"><a href="/archive">Archive</a></div>
                         <div id="about" class="navbar"><a href="/about">About</a></div>
                </div>
-->	</header>
</div>
 
         <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/posts/blog/15/06/21/distributed-id-generator.html" title="分布式ID生成器">分布式ID生成器</a></h1>
        <p class="entry-date">2015-06-21</p>
<!--
	
-->
	<h2 id="1-什么是id">1 什么是ID</h2>

<p>ID最大的特点就是<strong>唯一</strong>，一个ID存在的目的就是唯一性的标识某一个物体，如果唯一性做不到，那么ID也就失去了本质的作用。
另外ID还需要保持其它特性：</p>

<ul>
  <li><strong>有序</strong>   对于某些事物需要依靠ID来进行比较，同时对于排序查找也方便。</li>
  <li><strong>有意义</strong>  ID也需要包含有意义的信息，比如时间信息,业务信息。</li>
  <li><strong>分布式</strong> ID的生成也许并不在一台服务器上，可由多台服务器互不干扰的生成ID。如果采用中心式的ID生成，多半会涉及到锁，而锁意味着成本<!-- more -->和性能的下降。</li>
  <li><strong>紧凑</strong> 为了性能或者长度的原因，要求ID要保持紧凑。越长的ID可能表达的数字范围越大，但是在存储和网络中要占据更多的空间。因此，设计ID的时候往往是保证在未来的一段时间可用的前提下（查看<a href="https://en.wikipedia.org/wiki/Year_2038_problem">2038</a>问题），尽可能的缩短ID的长度。<code class="highlighter-rouge">总之，掌握好长度与时间范围之间的trade-off</code>。</li>
</ul>

<p>另外，参考原新浪weibo通讯技术专家 宇鹏的<a href="http://weibo.com/p/1001603800404851831206?from=page_100505_profile&amp;wvr=6&amp;mod=wenzhangmod">业务系统需要怎样的全局唯一ID</a>博文,文中还提到了另外两个特点：</p>

<ul>
  <li><strong>可反解</strong>
反解ID可以为排错提供良好的线索，ID从什么时候生成，在哪个机房生成的等等情况都可以一一了解到。</li>
  <li><strong>可制造</strong>
可制造针对的是当业务系统失败了，后续需要恢复数据重新进入业务系统，依赖于时间的数据需要在将来的时间段产生过去的时间数据。</li>
</ul>

<h2 id="2-分布式id生成的难点">2 分布式ID生成的难点</h2>
<p>分布式ID设计的难点在于对时间的控制，计算机时钟存在着“<strong>时钟偏移</strong>”的情况（查看<a href="queue.acm.org/detail.cfm?id=2745385">分布式环境下的共时性问题,ThereIsNoNow</a>）。<a href="http://www.ntp.org/">NTP</a>就是专门针对时钟偏移而设计来同步网络中各服务器时钟的协议。为了保持时间一致，NTP允许服务器的时间倒退。在分布式环境下，如果ID的产生绝对的依赖于时间，应该将NTP的这一特性关闭以免产生重复的ID（或者在ID生成器代码里应该对时间倒退的情况进行判断）。由于网络中各服务器到NTP服务器的跳数可能不同，同时由于网络的抖动，因此难以使得服务器之间的时钟绝对一致。</p>

<p>在分布式环境下的时钟不能保证绝对的一致，因此完全利用时钟来保证ID的唯一性是不可能的，但是可以把时间作为ID唯一性保证的一部分，另外利用其他的特性来保证ID全局的唯一性。ID结构中代表时间的那一部分可作排序之用，在ID尾部使用序列号来保证唯一性。同时，在ID结构中间还可以添加一些其他信息，比如机房号，服务器号等等信息。</p>

<p>谈及时间，进一步，到底是精确到秒，还是毫秒。<strong>生成ID的时间维度决定了业务的峰值速度</strong>。由于峰值的时间毕竟比较短，因此，针对处理峰值的情况，在固定长度的ID结构中，设计每秒100万比每毫秒1000更具有灵活性。</p>

<h2 id="3-竞品分析">3 竞品分析</h2>

<h3 id="31-snowflake">3.1 SnowFlake</h3>
<p><a href="http://engineering.twitter.com/2010/06/announcing-snowflake.html">SnowFlake</a>是为了解决Twitter在分布式环境下的全局ID的问题。
生成的ID需要满足两个要求：</p>

<ul>
  <li><strong>数据量</strong>
每秒能产生数十万个ID，来标识不同的推文</li>
  <li><strong>K-Sorted</strong>
ID大致有序。</li>
</ul>

<p>SnowFlake中的ID长度都是64位，由时间戳、节点号和序列编号组成。</p>

<p><strong>时间戳</strong> 以毫秒为单位，占41位，记录的是从 1288834974657 (Thu, 04 Nov 2010 01:42:54 GMT) 这一时刻到当前时间所经过的毫秒数。有时间戳，必然会存在着一个时间原点，默认情况下的时间元年为1970年1月1日 00:00:01。而在系统设计时，可以以当前的年份来表示元年，这样可以增加ID的使用年限。</p>

<p><strong>节点号</strong> 在源码中被分成两部分，数据中心的 ID 和节点 ID，各自占 5 位。</p>

<p><strong>序列编号</strong> 为本地编号，占12位，从0开始，到4095，然后循环又从0开始，也就是说每一毫秒每个节点能够产生4096的ID号。</p>

<p>还有一位为<strong>保留位</strong>，始终为0。</p>

<h3 id="32-icicle">3.2 Icicle</h3>

<p><a href="http://engineering.intenthq.com/2015/03/icicle-distributed-id-generation-with-redis-lua/">Icicle</a>的ID结构图：</p>

<p><img src="/images/idgenerator/snowflake.png" alt="icicle ID" /></p>

<p>Icicle的ID设计思路来源于SnowFlake，因此与SnowFlake的ID结构有很大的相似性。</p>

<p><strong>Sign</strong>
第一位为符号保留位，不使用，文中给出的解释为</p>

<blockquote>
  <p>which we chose not to use because some platforms make it difficult to get at and it messes with ordering</p>
</blockquote>

<p><strong>Time:</strong>
时间占41位。</p>

<p><strong>Shard ID:</strong>
由于Icicle是部署在redis上的，redis不支持分布式模式，因此shard id用来标记每一个redis实例，可支持1024个实例。</p>

<p><strong>Sequence ID:</strong> 与SnowFlake类似。</p>

<p>Icicle支持每一毫秒产生2^10 * 2^12个ID号。</p>

<h3 id="33-weibo">3.3 weibo</h3>
<p>微博使用了秒级的时间，用了30bit，Sequence 用了15bit，理论上可以搞定3.2w/s的速度。用4bit来区分IDC，也就是可以支持16个 IDC，对于核心机房来说够了。剩下的有2bit 用来区分业务，由于当前发号服务是机房中心式的，使用1bit来区分热备。可以看到微博的发号器总位数为52位，并没有用满一个long，即64bit。主要的原因是新老系统的兼容导致的。</p>

<h3 id="34-ticktick">3.4 Ticktick</h3>
<p>使用了30bit 的秒级时间，20bit 给Sequence。这里是有个考虑，第一版实现还是希望到毫秒级，所以20bit 的前10bit给了毫秒来用，剩下10bit给 Sequence。等到峰值提高的时候可以暂时回到秒级。</p>

<p>高位留了2bit 做 Version，或者到时候改造使用更长字节数，用第一位来标识不同 ID，或者可以把这2bit 挪给时间用，可以给系统改造留出一定的时间。</p>

<p>剩下的10bit 留给 MachineID，也就是说当前 ID 生成可以直接内嵌在业务服务中，最多支持千级别的服务器数量。最后有2bit 做Tag 用，可能区分群消息和单聊消息。同时你也看出，这个 ID 最多支持一天10亿消息（原文如此，一天的消息量按照第一版算应该是86400 * 1000 * 2^10 * 2^10 ），也是怕系统增速太快，这2bit 可以挪给 Sequence，可以支持40亿级别消息量，或者结合前面的版本支持到百亿级别。</p>

<p><img src="/images/idgenerator/idgenerator.jpg" alt="idgenerator" /></p>

<h2 id="4-参考">4 参考</h2>

<p>[1]<a href="http://engineering.intenthq.com/2015/03/icicle-distributed-id-generation-with-redis-lua/">icicle-distributed-id-generation-with-redis-lua</a></p>

<p>[2]<a href="https://github.com/twitter/snowflake">Snowflake</a></p>

<p>[3]<a href="http://www.dengchuanhua.com/132.html">http://www.dengchuanhua.com/132.html</a></p>

<p>[4]<a href="http://weibo.com/p/1001603800404851831206?from=page_100505_profile&amp;wvr=6&amp;mod=wenzhangmod">业务系统需要怎样的全局唯一ID</a></p>

	<ul class="pager">
            
            <li class="previous"><a href="/posts/blog/15/06/17/what-is-good-code.html" title="什么样的代码才是好的代码">上一篇 什么样的代码才是好的代码</a></li>
	    

            
            <li class="next"><a href="/posts/blog/15/06/21/etcd-vs-consul.html" title="ETCD vs. Consul">下一篇 ETCD vs. Consul</a></li>
            
	</ul>
	<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hongbing.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    </div>

    <div class="sidenav">
	<iframe width="100%" height="85" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=85&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2702608131&verifier=f3af5509&dpc=1"></iframe>
    </div>

    <div class="sidenav">
        <h2>Blog</h2>
        <ul class="artical-list">
        
            <li><a href="/posts/blog/19/08/29/why-502.html">为什么web服务器返回502</a></li>
        
            <li><a href="/posts/blog/18/04/22/redis-data-migration.html">阿里云redis数据拆分</a></li>
        
            <li><a href="/posts/blog/18/01/01/schedule-thread-executor-not-work.html">定时任务怎么不定时执行了</a></li>
        
            <li><a href="/posts/blog/17/10/15/dynamic-change-logger-level.html">动态变更log4j日志级别</a></li>
        
            <li><a href="/posts/blog/17/10/15/daily-shit.html">20171015一周坑</a></li>
        
            <li><a href="/posts/blog/17/04/22/spring-session-with-sharded-session.html">spring-session支持分片redis</a></li>
        
            <li><a href="/posts/blog/17/02/12/spring-session.html">spring session源码解析</a></li>
        
            <li><a href="/posts/blog/16/05/21/linux-common-command.html">工作中常用的linux命令</a></li>
        
            <li><a href="/posts/blog/16/05/19/hardware-interrupt-balance.html">硬件中断均衡</a></li>
        
            <li><a href="/posts/blog/16/04/17/a-oom-problem.html">一次oom的排查过程</a></li>
        
            <li><a href="/posts/blog/15/11/14/monitor-principle.html">监控模式</a></li>
        
            <li><a href="/posts/blog/15/11/14/jetty-deadlock.html">jetty6 deadlock</a></li>
        
            <li><a href="/posts/blog/15/08/21/linux-of-blockdump.html">linux系统之block_dump</a></li>
        
            <li><a href="/posts/blog/15/08/20/linux-of-pdflush.html">linux系统之pdflush</a></li>
        
            <li><a href="/posts/blog/15/08/11/UnknowHostException.html">UnknowHostException</a></li>
        
            <li><a href="/posts/blog/15/08/02/haproxy-install.html">haproxy部署</a></li>
        
            <li><a href="/posts/blog/15/07/25/maven-introduce.html">maven介绍</a></li>
        
            <li><a href="/posts/blog/15/06/21/etcd-vs-consul.html">ETCD vs. Consul</a></li>
        
            <li><a href="/posts/blog/15/06/21/distributed-id-generator.html">分布式ID生成器</a></li>
        
            <li><a href="/posts/blog/15/06/17/what-is-good-code.html">什么样的代码才是好的代码</a></li>
        
            <li><a href="/posts/blog/15/06/17/raft-introduce.html">Raft</a></li>
        
        </ul>
<!--
        <h2>Opinion</h2>
        <ul class="artical-list">
        
        </ul>

        <h2>Project</h2>
        <ul class="artical-list">
        
        </ul>-->
     </div>
</div>
<script src="/js/jquery-1.7.1.min.js"" type="text/javascript"></script>
<script src="/js/post.js" type="text/javascript"></script>

      

</body>
</html>

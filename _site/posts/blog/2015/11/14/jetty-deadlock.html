<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>jetty6 deadlock </title>
    <meta name="author" content="hongbing" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="hongbing的部落格" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
    <link rel="shortcut icon" href="/jinchuan.png" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>
      <div id="header_wrap" class="outer">
        <header class="inner">
                <div id="project_title" align="center"><a href="/">hongbingの部落格</a></div>
                <div id="project_tagline" align="center">ONCE A GEEK, FOREVER A GEEK</div>
    <!--    
	        <div id="nav" class="navbar">
                         <div id="home" class="navbar"><a href="/">Home</a></div>
                         <div id="archive" class="navbar"><a href="/archive">Archive</a></div>
                         <div id="about" class="navbar"><a href="/about">About</a></div>
                </div>
-->	</header>
</div>
 
         <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/posts/blog/2015/11/14/jetty-deadlock.html" title="jetty6 deadlock">jetty6 deadlock</a></h1>
        <p class="entry-date">2015-11-14</p>
<!--
	
        <ul id="pagenav">
           
               <li><a href="">java</a></li>
           
               <li><a href="#java"></a></li>
           
        </ul>
        
-->
	<h2 id="section">1 背景</h2>
<p>业务方反应消息队列最近几天输出的消息量变少了（良好的监控系统应该在业务方感知到故障之前将问题暴露出来），进入到前端机发现，多达20多万的TCP连接状态都处于<code>CLOSE_WAIT</code>状态，且TCP socket的RECV-Q中还有100多个包没有被处理。<br />
我们使用的环境是：</p>

<ul>
  <li>java</li>
</ul>

<p>java version “1.6.0_24”<br />
Java(TM) SE Runtime Environment (build 1.6.0_24-b07)<!-- more --><br />
Java HotSpot(TM) 64-Bit Server VM (build 19.1-b02, mixed mode)</p>

<ul>
  <li>jetty</li>
</ul>

<p>jetty 6.1.26</p>

<h2 id="section-1">2 分析</h2>
<p>看到大量的tcp连接都处于CLOSE_WAIT状态，初步分析了一下网络状况，如果服务端处于CLOSE_WAIT状态，说明是客户端首先发起了关闭请求。但是在这个项目中，客户端与服务端之间采用的是jetty长连接，服务端在服务10分钟之后主动断开连接，客户端重新发起请求。明显，现在出现的情况与设计是不符合的。为了尽快恢复服务状况，释放服务端的连接，于是重启了服务端程序。重启之后，服务暂时恢复正常。在重启之前，使用jstack dump了一份当前java进程的线程栈,发现在dump的文件最后，检测到了deadlock，内容如下：</p>

<pre><code class="language-java"> Java stack information for the threads listed above:
"1854411210@qtp-1306606930-148":
	at org.mortbay.io.nio.SelectorManager$SelectSet.scheduleIdle(SelectorManager.java:795)
	- waiting to lock &lt;0x00000006fd82b228&gt; (a org.mortbay.io.nio.SelectorManager$SelectSet)
	at org.mortbay.io.nio.SelectChannelEndPoint.scheduleIdle(SelectChannelEndPoint.java:159)
	at org.mortbay.io.nio.SelectChannelEndPoint.blockWritable(SelectChannelEndPoint.java:293)
	- locked &lt;0x0000000777e8d338&gt; (a org.mortbay.jetty.nio.SelectChannelConnector$ConnectorEndPoint)
	at org.mortbay.jetty.AbstractGenerator$Output.blockForOutput(AbstractGenerator.java:544)
	at org.mortbay.jetty.AbstractGenerator$Output.flush(AbstractGenerator.java:571)
	at org.mortbay.jetty.HttpConnection$Output.flush(HttpConnection.java:1010)
	at cn.xxxx.xxxxx.channel.DataOutputChannel.process(DataOutputChannel.java:23)
	at cn.xxxx.xxxxx.channel.DataChannel.handler(DataChannel.java:40)
	at cn.xxxx.xxxxx.channel.DataChannelFactory.handler(DataChannelFactory.java:27)
	at cn.xxxx.xxxxx.processor.ClientProcessor.outputDataMessage(ClientProcessor.java:287)
	at cn.xxxx.xxxxx.processor.ClientProcessor.outputDataMessage(ClientProcessor.java:259)
	at cn.xxxx.xxxxx.processor.ClientProcessor.handler(ClientProcessor.java:82)
	at cn.xxxx.xxxxx.web.DataServlet.service(DataServlet.java:34)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:820)
	at org.mortbay.jetty.servlet.ServletHolder.handle(ServletHolder.java:511)
	at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:390)
	at org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)
	at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)
	at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:765)
	at org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:440)
	at org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:230)
	at org.mortbay.jetty.handler.HandlerCollection.handle(HandlerCollection.java:114)
	at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)
	at org.mortbay.jetty.Server.handle(Server.java:326)
	at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)
	at org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:926)
	at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:549)
	at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212)
	at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)
	at org.mortbay.io.nio.SelectChannelEndPoint.run(SelectChannelEndPoint.java:410)
	at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)

"965223859@qtp-1306606930-25 - Acceptor14 SelectChannelConnector@0.0.0.0:8082":
	at org.mortbay.io.nio.SelectChannelEndPoint.updateKey(SelectChannelEndPoint.java:322)
	- waiting to lock &lt;0x0000000777e8d338&gt; (a org.mortbay.jetty.nio.SelectChannelConnector$ConnectorEndPoint)
	at org.mortbay.io.nio.SelectChannelEndPoint.close(SelectChannelEndPoint.java:456)
	at org.mortbay.jetty.nio.SelectChannelConnector$ConnectorEndPoint.close(SelectChannelConnector.java:362)
	at org.mortbay.io.nio.SelectChannelEndPoint.idleExpired(SelectChannelEndPoint.java:174)
	at org.mortbay.io.nio.SelectChannelEndPoint$IdleTask.expire(SelectChannelEndPoint.java:489)
	at org.mortbay.thread.Timeout.tick(Timeout.java:137)
	- locked &lt;0x00000006fd82b228&gt; (a org.mortbay.io.nio.SelectorManager$SelectSet)
	at org.mortbay.thread.Timeout.tick(Timeout.java:153)
	at org.mortbay.io.nio.SelectorManager$SelectSet.doSelect(SelectorManager.java:762)
	at org.mortbay.io.nio.SelectorManager.doSelect(SelectorManager.java:192)
	at org.mortbay.jetty.nio.SelectChannelConnector.accept(SelectChannelConnector.java:124)
	at org.mortbay.jetty.AbstractConnector$Acceptor.run(AbstractConnector.java:708)
	at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)
</code></pre>

<p>另一方面，跟业务方要了一份客户端的代码。发现客户端确实在应用层面主动关闭了连接（why，不按照设计来？？），这样也解释了为什么会在服务端出现CLOSE_WAIT状态。</p>

<p>接下来看看服务端代码的deadlock:</p>

<p>跟踪调用链路可以看到死锁的发生，一个线程锁在了<code>org.mortbay.io.nio.SelectorManager$SelectSet</code>上，并且等待<code>rg.mortbay.jetty.nio.SelectChannelConnector$ConnectorEndPoint</code>的解锁，另一个则相反。</p>

<p>对于线程<code>1854411210@qtp-1306606930-148</code>，如果没有等待<code>org.mortbay.io.nio.SelectorManager$SelectSet</code>解锁，那么会发生什么呢？看看下面的代码：</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(!</span><span class="n">_generator</span><span class="o">.</span><span class="na">_endp</span><span class="o">.</span><span class="na">blockWritable</span><span class="o">(</span><span class="n">_maxIdleTime</span><span class="o">))</span>
<span class="o">{</span>
     <span class="n">_generator</span><span class="o">.</span><span class="na">_endp</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
     <span class="k">throw</span> <span class="k">new</span> <span class="nf">EofException</span><span class="o">(</span><span class="s">"timeout"</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">_generator</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span></code></pre></div>

<p>等待解锁的调用走到了<code>_generator._endp.blockWritable()</code>方法的内部，如果没有形成死锁，那么等到<code>_maxIdleTime</code>时间到，要么执行flush操作，将数据传输到对端，要么关闭连接，并抛出<strong>timeout</strong>异常。因此不会产生前文所描述的服务端的大部分请求连接都处于CLOSE_WAIT状态，导致无法提供服务。</p>

<p>知道了产生问题的原因，在网上搜索关键词<strong>jetty6 deadlock</strong>会有不少这方面的bug report。网上也一直以为是<a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=357318">jetty6的bug</a>，然而经过jetty相关开发人员的验证，最终由oracle方面证实是<a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=7130796">jdk的bug</a>，且该bug已经在jdk8-b28得到修复。</p>

<p>接下来我们需要做的就是升级系统到jdk8-b28及其以上，同时将jetty升级到jetty8。</p>

<p><img src="/images/jettydeadlock/jettydeadlock.jpg" alt="deadlock" /></p>

	<ul class="pager">
            
            <li class="previous"><a href="/posts/blog/2015/08/21/linux-of-blockdump.html" title="linux系统之block_dump">上一篇 linux系统之block_dump</a></li>
	    

            
            <li class="next"><a href="/posts/blog/2015/11/14/monitor-principle.html" title="监控模式">下一篇 监控模式</a></li>
            
	</ul>
	<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hongbing.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    </div>

    <div class="sidenav">
	<iframe width="100%" height="85" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=85&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2702608131&verifier=f3af5509&dpc=1"></iframe>
    </div>

    <div class="sidenav">
        <h2>Blog</h2>
        <ul class="artical-list">
        
            <li><a href="/posts/blog/2017/02/12/spring-session.html">spring session源码解析</a></li>
        
            <li><a href="/posts/blog/2016/06/15/nginx-lua.html">openresty memcached实践</a></li>
        
            <li><a href="/posts/blog/2016/05/21/linux-common-command.html">工作中常用的linux命令</a></li>
        
            <li><a href="/posts/blog/2016/05/19/hardware-interrupt-balance.html">硬件中断均衡</a></li>
        
            <li><a href="/posts/blog/2016/04/17/a-oom-problem.html">一次oom的排查过程</a></li>
        
            <li><a href="/posts/blog/2015/11/14/monitor-principle.html">监控模式</a></li>
        
            <li><a href="/posts/blog/2015/11/14/jetty-deadlock.html">jetty6 deadlock</a></li>
        
            <li><a href="/posts/blog/2015/08/21/linux-of-blockdump.html">linux系统之block_dump</a></li>
        
            <li><a href="/posts/blog/2015/08/20/linux-of-pdflush.html">linux系统之pdflush</a></li>
        
            <li><a href="/posts/blog/2015/08/11/UnknowHostException.html">UnknowHostException</a></li>
        
            <li><a href="/posts/blog/2015/08/02/haproxy-install.html">haproxy部署</a></li>
        
            <li><a href="/posts/blog/2015/07/25/maven-introduce.html">maven实践</a></li>
        
            <li><a href="/posts/blog/2015/06/21/etcd-vs-consul.html">ETCD vs. Consul</a></li>
        
            <li><a href="/posts/blog/2015/06/21/distributed-id-generator.html">分布式ID生成器</a></li>
        
            <li><a href="/posts/blog/2015/06/17/what-is-good-code.html">什么样的代码才是好的代码</a></li>
        
            <li><a href="/posts/blog/2015/06/17/raft-introduce.html">Raft</a></li>
        
        </ul>
<!--
        <h2>Opinion</h2>
        <ul class="artical-list">
        
        </ul>

        <h2>Project</h2>
        <ul class="artical-list">
        
        </ul>-->
     </div>
</div>
<script src="/js/jquery-1.7.1.min.js"" type="text/javascript"></script>
<script src="/js/post.js" type="text/javascript"></script>

      

</body>
</html>

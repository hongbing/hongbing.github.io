<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>UnknowHostException </title>
    <meta name="author" content="hongbing" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="hongbing的部落格" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
    <link rel="shortcut icon" href="/jinchuan.png" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>
      <div id="header_wrap" class="outer">
        <header class="inner">
                <div id="project_title" align="center"><a href="/">hongbingの部落格</a></div>
                <div id="project_tagline" align="center">ONCE A GEEK, FOREVER A GEEK</div>
    <!--    
	        <div id="nav" class="navbar">
                         <div id="home" class="navbar"><a href="/">Home</a></div>
                         <div id="archive" class="navbar"><a href="/archive">Archive</a></div>
                         <div id="about" class="navbar"><a href="/about">About</a></div>
                </div>
-->	</header>
</div>
 
         <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/2015-08-11-UnknowHostException" title="UnknowHostException">UnknowHostException</a></h1>
        <p class="entry-date">2015-08-11</p>
<!--	
	
-->	
	<h2 id="section">1 <strong>问题</strong></h2>

<p>团队使用Docker中的测试环境，在新起的测试环境中启动消息队列项目，项目启动失败，抛出如下异常：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">UnknowHostException</span><span class="err">：</span>
	<span class="n">java</span><span class="o">.</span><span class="na">net</span><span class="o">.</span><span class="na">UnknownHostException</span><span class="o">:</span> <span class="nl">e7a05a2abfc5:</span> <span class="nl">e7a05a2abfc5:</span> <span class="err">未知的名称或服务</span></code></pre></figure>

<h2 id="section-1">2 <strong>分析</strong></h2>

<p>异常信息栈显示抛出异常的地方在：<code class="highlighter-rouge">InetAddress localHost = InetAddress.getLocalHost();</code>
<!-- more -->
  跟踪源代码发现<code class="highlighter-rouge">InetAddress.getLocalHost()</code>会调用<strong>Inet6AddressImpl</strong>或者<strong>Inet4AddressImpl</strong>的native方法：</p>

 	public native String getLocalHostName() throws UnknownHostException;

<p>该native方法直接执行linux的系统调用gethostname。系统调用gethostname与在终端执行<code class="highlighter-rouge">$ hostname</code>或者<code class="highlighter-rouge">$ cat /etc/hostname</code>的结果一致。获得hostname后，比较该hostname的值，如果为localhost，则执行<code class="highlighter-rouge">impl.loopbackAddress();</code>获得localhost对应的ip地址。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="n">local</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">))</span> <span class="o">{</span>
              <span class="k">return</span> <span class="n">impl</span><span class="o">.</span><span class="na">loopbackAddress</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
	<span class="o">......</span>
<span class="kd">synchronized</span> <span class="o">(</span><span class="n">cacheLock</span><span class="o">)</span> <span class="o">{</span>
              <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">cachedLocalHost</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">if</span> <span class="o">((</span><span class="n">now</span> <span class="o">-</span> <span class="n">cacheTime</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">maxCacheTime</span><span class="o">)</span> <span class="c1">// Less than 5s old?
</span>
                      <span class="n">ret</span> <span class="o">=</span> <span class="n">cachedLocalHost</span><span class="o">;</span>
                  <span class="k">else</span>
                      <span class="n">cachedLocalHost</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
              <span class="o">}</span>
              <span class="c1">// we are calling getAddressesFromNameService directly
</span>
              <span class="c1">// to avoid getting localHost from cache
</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">ret</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">InetAddress</span><span class="o">[]</span> <span class="n">localAddrs</span><span class="o">;</span>
                  <span class="k">try</span> <span class="o">{</span>
                      <span class="n">localAddrs</span> <span class="o">=</span>
                          <span class="n">InetAddress</span><span class="o">.</span><span class="na">getAddressesFromNameService</span><span class="o">(</span><span class="n">local</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">UnknownHostException</span> <span class="n">uhe</span><span class="o">)</span> <span class="o">{</span>
                      <span class="c1">// Rethrow with a more informative
</span>
		<span class="n">UnknownHostException</span> <span class="n">uhe2</span> <span class="o">=</span>
                          <span class="k">new</span> <span class="n">UnknownHostException</span><span class="o">(</span><span class="n">local</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span>
                                                   <span class="n">uhe</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                      <span class="n">uhe2</span><span class="o">.</span><span class="na">initCause</span><span class="o">(</span><span class="n">uhe</span><span class="o">);</span>
                      <span class="k">throw</span> <span class="n">uhe2</span><span class="o">;</span>
                  <span class="o">}</span>
                  <span class="n">cachedLocalHost</span> <span class="o">=</span> <span class="n">localAddrs</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
                  <span class="n">cacheTime</span> <span class="o">=</span> <span class="n">now</span><span class="o">;</span>
                  <span class="n">ret</span> <span class="o">=</span> <span class="n">localAddrs</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
              <span class="o">}</span>
          <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>如果不是localhost，则会读取缓存;如果缓存不存在，调用<code class="highlighter-rouge">InetAddress.getAddressesFromNameService(local, null)</code>。该方法调用native的<code class="highlighter-rouge">lookupAllHostAddr</code>方法，该方法会在/etc/hosts里面查找对应host的ip地址，如果没有则抛出UnknowHostException。</p>

<h2 id="section-2">3 <strong>解决方法</strong></h2>

<p>知道了异常发生的原因，那么解决方法只需要在/etc/hosts里面添加一项</p>

<p><code class="highlighter-rouge">127.0.0.1 e7a05a2abfc5</code></p>

<p>即可。另外还可以选择将<code class="highlighter-rouge">hostname</code>的值改为<code class="highlighter-rouge">localhost</code>的方式来解决问题。</p>

<p><img src="/images/unknowhostexception/thatslove.jpg" alt="thatslove" /></p>

	<ul class="pager">
            
            <li class="previous"><a href="/2015-08-02-haproxy-install" title="haproxy部署">上一篇 haproxy部署</a></li>
	    

            
            <li class="next"><a href="/2015-08-20-linux-of-pdflush" title="linux系统之pdflush">下一篇 linux系统之pdflush</a></li>
            
	</ul>
	<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hongbing.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    </div>

    <div class="sidenav">
	<iframe width="100%" height="85" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=85&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2702608131&verifier=f3af5509&dpc=1"></iframe>	
    </div>
	
    <div class="sidenav">
        <h2>Blog</h2>
        <ul class="artical-list">
        
            <li><a href="/2015-11-14-monitor-principle">监控模式</a></li>
        
            <li><a href="/2015-11-14-jetty-deadlock">jetty6 deadlock</a></li>
        
            <li><a href="/2015-08-21-linux-of-blockdump">linux系统之block_dump</a></li>
        
            <li><a href="/2015-08-20-linux-of-pdflush">linux系统之pdflush</a></li>
        
            <li><a href="/2015-08-11-UnknowHostException">UnknowHostException</a></li>
        
            <li><a href="/2015-08-02-haproxy-install">haproxy部署</a></li>
        
            <li><a href="/2015-07-25-maven-introduce">maven实践</a></li>
        
            <li><a href="/2015-06-21-etcd-vs-consul">ETCD vs. Consul</a></li>
        
            <li><a href="/2015-06-21-distributed-id-generator">分布式ID生成器</a></li>
        
            <li><a href="/2015-06-17-what-is-good-code">什么样的代码才是好的代码</a></li>
        
            <li><a href="/2015-06-17-raft-introduce">Raft</a></li>
        
        </ul>
<!--
        <h2>Opinion</h2>
        <ul class="artical-list">
        
        </ul>

        <h2>Project</h2>
        <ul class="artical-list">
        
        </ul>-->
     </div>
</div>
<script src="/js/jquery-1.7.1.min.js"" type="text/javascript"></script>
<script src="/js/post.js" type="text/javascript"></script>

      

</body>
</html>

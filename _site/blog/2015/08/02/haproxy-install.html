<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>haproxy部署 </title>
    <meta name="author" content="hongbing" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="hongbing的部落格" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
    <link rel="shortcut icon" href="/jinchuan.png" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>
      <div id="header_wrap" class="outer">
        <header class="inner">
                <div id="project_title" align="center"><a href="/">hongbingの部落格</a></div>
                <div id="project_tagline" align="center">ONCE A GEEK, FOREVER A GEEK</div>
    <!--    
	        <div id="nav" class="navbar">
                         <div id="home" class="navbar"><a href="/">Home</a></div>
                         <div id="archive" class="navbar"><a href="/archive">Archive</a></div>
                         <div id="about" class="navbar"><a href="/about">About</a></div>
                </div>
-->	</header>
</div>
 
         <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/blog/2015/08/02/haproxy-install.html" title="haproxy部署">haproxy部署</a></h1>
        <p class="entry-date">2015-08-02</p>
<!--	
	
-->	
	<h2 id="section">1 安装</h2>

<p>下载haproxy源码，目前国内无法访问haproxy官网（www.haproxy.org），<strong>Fuck GFW</strong>。<br />
 可以通过直接访问http://www.haproxy.org/download/1.5/src/地址，选择相应的版本下载。或者使用</p>

<pre><code> wget http://www.haproxy.org/download/1.5/src/haproxy-1.5.12.tar.gz
</code></pre>

<p>下载，下载完成后，将其解压。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd </span>haproxy-X.Y.Z
uname -a
make <span class="nv">TARGET</span><span class="o">=</span>linux26 <span class="nv">PREFIX</span><span class="o">=</span>/usr/local/haproxy install</code></pre></div>

<!-- more -->
<p>linux26,26表示linux系统的主次版本号。<br />
执行上面的命令，输出done就正确安装完成。</p>

<h2 id="section-1">2 配置</h2>

<ul>
  <li>修改配置</li>
</ul>

<p>配置文件可以参考源码里面examples下面的haproxy.cfg文件，haproxy里的配置参数可到<a href="http://cbonte.github.io/haproxy-dconv/index.html">haproxy-dconv</a>查看。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /usr/local/haproxy
mkdir conf logs
vim /conf/haproxy.cfg</code></pre></div>

<p>下面是参考配置</p>

<pre><code>  global  //全局配置参数，进程级
    log 127.0.0.1 local0//日志输出配置，所有日志都记录在本机，通过local0输出
    maxconn  5120  //每个进程的最大连接数 
    chroot   /usr/local/haproxy  //改变当前工作目录
    uid      100  //所属用户的uid
    gid      100  //所属用户的gid
    daemon  //以后台形式运行haproxy   
    nbproc   2  //创建2个进程进去deamon模式
    pidfile  /usr/local/haproxy/logs/haproxy.pid  //pid文件
  defaults  
    log     127.0.0.1  local3  err
    mode    http  //http七层,tcp4层,health只返回OK
    option  httplog  //采用httpd日志格式
    option  dontlognull  
    option  redispatch  
    retries 3  //三次失败认为服务不可用
    maxconn 3000  //默认的最大连接数
    contimeout 5000  //连接超时时间
    clitimeout 50000  //客户端超时时间
    srvtimeout 50000  //服务器超时时间
    stats enable  
    stats uri /admin  //统计页面的url
    stats auth admin:admin  //统计页面的用户名密码
    stats realm Haproxy \ statistic  //统计页面提示信息
    stats hide-version//隐藏统计页面版本信息
   listen web_proxy *:80
        server web1 192.168.1.128:80 check inter 5000 fall 1 rise 2  
        server web1 192.168.1.128:8080 check inter 5000 fall 1 rise 2
    //check inter 5000 是检测心跳频率，rise 2 是2次正确认为服务可用，fall 1 是1次失败认为服务不可用，weight代表权重
</code></pre>

<p>global是进程级别的参数；代理参数可以设置defaults，listen，frontend和backend。listen是frontend和backend的组合，可以设置frontend的端口，backend的server节点，以及一些其他参数。</p>

<ul>
  <li>配置日志环境</li>
</ul>

<p><code>vim /etc/syslog.conf </code></p>

<p>添加</p>

<pre><code>local0.*        /usr/local/logs/haproxy.log 
local3.*        /usr/local/logs/haproxy_err.log 
</code></pre>

<p>使用<code>vim /etc/sysconfig/syslog</code>设置系统接收外来日志，修改</p>

<pre><code>SYSLOGD_OPTIONS="-r -m 0"
</code></pre>

<ul>
  <li>启动命令</li>
</ul>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">./sbin/haproxy -f ./conf/haproxy.cfg</code></pre></div>

<ul>
  <li>重启命令</li>
</ul>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">./sbin/haproxy -f ./conf/haproxy.cfg -st <span class="o">[</span>haproxy.pid<span class="o">]</span></code></pre></div>

<ul>
  <li>停止命令</li>
</ul>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">killall haproxy</code></pre></div>

<ul>
  <li>reload配置</li>
</ul>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">./sbin/haproxy -f ./conf/haproxy.cfg -sf <span class="o">[</span>haproxy.pid<span class="o">]</span></code></pre></div>

<p>可以在修改haproxy.cfg后，快速重载变更配置。<br />
<img src="/images/haproxy/haproxy.jpg" alt="haproxy" /></p>

	<ul class="pager">
            
            <li class="previous"><a href="/blog/2015/07/25/maven-introduce.html" title="maven实践">上一篇 maven实践</a></li>
	    

            
            <li class="next"><a href="/blog/2015/08/11/UnknowHostException.html" title="UnknowHostException">下一篇 UnknowHostException</a></li>
            
	</ul>
	<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        
        s.src = '//hongbing.disqus.com/embed.js';
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    </div>

    <div class="sidenav">
	<iframe width="100%" height="85" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=85&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=2702608131&verifier=f3af5509&dpc=1"></iframe>	
    </div>
	
    <div class="sidenav">
        <h2>Blog</h2>
        <ul class="artical-list">
        
            <li><a href="/blog/2015/11/14/monitor-principle.html">监控模式</a></li>
        
            <li><a href="/blog/2015/11/14/jetty-deadlock.html">jetty6 deadlock</a></li>
        
            <li><a href="/blog/2015/08/21/linux-of-blockdump.html">linux系统之block_dump</a></li>
        
            <li><a href="/blog/2015/08/20/linux-of-pdflush.html">linux系统之pdflush</a></li>
        
            <li><a href="/blog/2015/08/11/UnknowHostException.html">UnknowHostException</a></li>
        
            <li><a href="/blog/2015/08/02/haproxy-install.html">haproxy部署</a></li>
        
            <li><a href="/blog/2015/07/25/maven-introduce.html">maven实践</a></li>
        
            <li><a href="/blog/2015/06/21/etcd-vs-consul.html">ETCD vs. Consul</a></li>
        
            <li><a href="/blog/2015/06/21/distributed-id-generator.html">分布式ID生成器</a></li>
        
            <li><a href="/blog/2015/06/17/what-is-good-code.html">什么样的代码才是好的代码</a></li>
        
            <li><a href="/blog/2015/06/17/raft-introduce.html">Raft</a></li>
        
        </ul>
<!--
        <h2>Opinion</h2>
        <ul class="artical-list">
        
        </ul>

        <h2>Project</h2>
        <ul class="artical-list">
        
        </ul>-->
     </div>
</div>
<script src="/js/jquery-1.7.1.min.js"" type="text/javascript"></script>
<script src="/js/post.js" type="text/javascript"></script>

      

</body>
</html>
